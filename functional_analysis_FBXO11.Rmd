---
title: 'Functional Analysis: shFBXO11'
author: "Jennifer Grants"
date: "1/31/2019"
output: 
  html_document:
    keep_md: true
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(biomaRt)
```

# Load common effect cluster gene Limma analysis results  
```{r common_effect_limma}
files <- list.files("./FBXO11/Limma", full.names = T)
files

a <- read.csv(files[2])
b <- read.csv(files[1])

head(a)
head(b)
```


# Biomart conversion of transcript names to gene names
```{r}
human <- useMart("ensembl", "hsapiens_gene_ensembl")
attr <- listAttributes(human)
genes.of.int <- c(as.character(a$Transcript), as.character(b$Transcript)) %>% unique()
head(genes.of.int)
```

```{r}
anno <- getBM(attributes = c("ensembl_transcript_id", "hgnc_symbol"), filters = "ensembl_transcript_id", values = genes.of.int, mart = human)

a$Gene_name <- anno[match(a$Transcript, anno$ensembl_transcript_id),]$hgnc_symbol
b$Gene_name <- anno[match(b$Transcript, anno$ensembl_transcript_id),]$hgnc_symbol

head(a)
head(b)
```


# Make GSEA expression datasets (for common effect genes only)  

> It's typical to make expression datasets for everything, and then let GSEA sort out which are significant and the same in all files. BUT, I want to focus on the things that are the same between the 2 shFBXO11 constructs, so I'm going to limit the expression data to the common effect genes.  

```{r}
# load the expr data and metadata
load("./FBXO11/expr.RData")
load("./FBXO11/libs.RData")

# repeat add design factors
libs$treatment <- ifelse(test = grepl(pattern = "shSCR", x = libs$specimen_subset_external_id), yes = "shSCR", no = 
                           ifelse(test = grepl(pattern = "shFBXO11#9", x = libs$specimen_subset_external_id), yes = "shFBXO11.9", no = "shFBXO11.10"))

# select expression data for common genes only
## first test if expr_a and expr_b genes are truly all same
genes_a <- dplyr::select(a, Transcript) %>% arrange(Transcript) %>% unlist()
genes_b <- dplyr::select(b, Transcript) %>% arrange(Transcript) %>% unlist()

identical(genes_a, genes_b)

## now limit the expr data frame to only transcripts covered in a & b (identical)
expr_common <- expr[which(expr$Name %in% a$Transcript),]
expr_common$Gene_name <- anno[match(expr_common$Name, anno$ensembl_transcript_id),]$hgnc_symbol

# make GSEA expression set format
expr_set <- dplyr::select(expr_common, Gene_name, everything(), -Name) %>%
  filter(Gene_name != "")

head(expr_set)

```

```{r}
write.table(x = expr_set, file = "./FBXO11/GSEA_")
```

